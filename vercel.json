<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>萬物價格掃描器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: #fff;
        }

        /* 頁面容器 */
        .page {
            display: none;
            min-height: 100vh;
            position: relative;
        }

        .page.active {
            display: block;
        }

        /* 頂部導航欄 */
        .nav-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            background: #fff;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #eee;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* 底部導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-nav.hidden {
            display: none;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            fill: #999;
            margin-bottom: 4px;
        }

        .nav-item.active svg {
            fill: #FF6B35;
        }

        .nav-item span {
            font-size: 12px;
            color: #999;
        }

        .nav-item.active span {
            color: #FF6B35;
        }

        /* 相機按鈕特殊樣式 */
        .nav-camera {
            position: relative;
        }

        .camera-btn {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .camera-btn svg {
            width: 30px;
            height: 30px;
            fill: #fff;
        }

        /* 設定頁面樣式 */
        .settings-page {
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #FF6B35;
            margin: 20px 20px 10px;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .list-item-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .list-item-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            fill: #666;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-size: 16px;
            color: #333;
        }

        .list-item-subtitle {
            font-size: 14px;
            color: #999;
            margin-top: 2px;
        }

        .list-item-arrow {
            width: 20px;
            height: 20px;
            fill: #999;
        }

        /* Switch 開關 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #FF6B35;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* 相機頁面 */
        .camera-page {
            position: relative;
            height: 100vh;
            background: #000;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .close-camera {
            position: absolute;
            top: 40px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
        }

        .close-camera svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        /* 掃描框 */
        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .scan-text {
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .scan-frame {
            width: 280px;
            height: 280px;
            position: relative;
        }

        /* 四角邊框樣式 */
        .scan-frame::before,
        .scan-frame::after,
        .scan-corner-tl,
        .scan-corner-tr {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #fff;
        }

        .scan-frame::before {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }

        .scan-frame::after {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }

        .scan-corner-tl {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }

        .scan-corner-tr {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }

        /* 底部控制 */
        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            pointer-events: all;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            cursor: pointer;
        }

        .capture-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
        }

        /* 照片列表頁 */
        .list-page {
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .search-container {
            padding: 10px 20px;
            background: #fff;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 10px 15px;
        }

        .search-icon {
            width: 20px;
            height: 20px;
            fill: #999;
            margin-right: 10px;
        }

        .search-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 16px;
            outline: none;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            padding: 20px;
        }

        .empty-icon {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .empty-icon svg {
            width: 50px;
            height: 50px;
            fill: #ccc;
        }

        .empty-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 14px;
            color: #999;
        }

        /* 載入動畫 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #fff;
            font-size: 18px;
        }

        /* 結果面板 */
        .result-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            height: 90vh;
            background: #fff;
            border-radius: 20px 20px 0 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            overflow: hidden;
        }

        .result-panel.active {
            bottom: 0;
        }

        .panel-header {
            position: relative;
            padding: 15px 20px;
        }

        .panel-handle {
            width: 60px;
            height: 5px;
            background: #ddd;
            border-radius: 3px;
            margin: 0 auto;
        }

        .panel-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 30px;
            height: 30px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .panel-close-btn:hover {
            background: #e0e0e0;
        }

        .panel-close-btn svg {
            width: 16px;
            height: 16px;
            fill: #666;
        }

        .result-content {
            padding: 0 20px 20px;
            overflow-y: auto;
            height: calc(100% - 65px);
        }

        .price-section {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8A65 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .price-value {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        /* Canvas for photo capture */
        #photoCanvas {
            display: none;
        }

        /* 歷史記錄樣式 */
        .history-section {
            padding: 0 20px;
        }

        .month-label {
            font-size: 16px;
            font-weight: 600;
            color: #666;
            margin: 20px 0 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-item {
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .history-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .history-info {
            padding: 10px;
        }

        .history-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-price {
            font-size: 16px;
            color: #FF6B35;
            font-weight: 700;
        }

        .history-date {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* 文件輸入隱藏 */
        #fileInput {
            display: none;
        }

        /* 聊天頁面樣式 */
        .chat-page {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fff;
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-header {
            position: relative;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chat-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 35px;
            height: 35px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-close-btn:hover {
            background: #e0e0e0;
        }

        .chat-close-btn svg {
            width: 18px;
            height: 18px;
            fill: #666;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #FF6B35;
            color: white;
        }

        .message.assistant .message-content {
            background: #e8e8e8;
            color: #333;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .message.user .message-avatar {
            background: #FF6B35;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #666;
            color: white;
        }

        .chat-input-area {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #FF6B35;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #FF6B35;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: #ff5722;
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .chat-loading {
            display: flex;
            gap: 4px;
            padding: 12px;
        }

        .chat-loading span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: chatLoading 1.4s ease-in-out infinite;
        }

        .chat-loading span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chat-loading span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes chatLoading {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .disclaimer-text {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 設定頁面 -->
        <div class="page settings-page" id="settingsPage">
            <div class="nav-header">
                <h1 class="app-title">設定</h1>
            </div>
            
            <div class="section">
                <h2 class="section-title">會員服務</h2>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M5 16L3 5l5.5 0L12 16m3.5 0H21l-2-11L14 5"/>
                        </svg>
                        <div class="list-item-content">
                            <div class="list-item-title">會員狀態</div>
                            <div class="list-item-subtitle">免費版</div>
                        </div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-item-title" style="margin-left: 39px;">剩餘掃描次數: 50</div>
                    </div>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        <div class="list-item-title">復原購買</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Pro 版功能</h2>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <div class="list-item-title">匯出成PDF報告</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <div class="list-item-title">多張照片批次辨識</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                        </svg>
                        <div class="list-item-title">自動儲存到相簿</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="autoSaveToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M22 2.53L16.47 8 13 11.5l-1.5 1.5L8 16.47 2.53 22 1 20.47 6.47 15 11 10.5l1.5-1.5L16 5.47 20.47 1 22 2.53M10.94 13L2 22v-2l8.94-9L11 11l-.06 2M13 10.94L22 2h-2l-9 8.94v.12L13 13v-2.06"/>
                        </svg>
                        <div class="list-item-title">AI智能服務</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="aiServiceToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">支援</h2>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M21 9L17.5 14.5C17.08 15.08 16.5 15.5 15.91 15.68L11.7 16.89C11.45 16.96 11.21 17 11 17C10.5 17 10.08 16.76 9.82 16.3L7.91 12.72C7.66 12.17 7.9 11.5 8.47 11.28L12.66 9.61C13.22 9.39 13.86 9.63 14.12 10.2L15.38 12.94L18.5 8.5L21 9Z"/>
                        </svg>
                        <div class="list-item-title">語言</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                        </svg>
                        <div class="list-item-title">聯絡我們</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 相機頁面 -->
        <div class="page camera-page" id="cameraPage">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="photoCanvas"></canvas>
            
            <div class="camera-overlay">
                <div class="close-camera" onclick="goToHome()">
                    <svg viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </div>

                <div class="scan-area">
                    <p class="scan-text">確保物品清晰地位於鏡頭焦點中</p>
                    <div class="scan-frame" id="scanFrame">
                        <span class="scan-corner-tl"></span>
                        <span class="scan-corner-tr"></span>
                    </div>
                </div>

                <div class="camera-controls">
                    <button class="control-btn" onclick="selectFromGallery()">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </button>
                    
                    <button class="capture-btn" onclick="capturePhoto()"></button>
                    
                    <button class="control-btn" onclick="toggleFlash()">
                        <svg viewBox="0 0 24 24">
                            <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 照片列表頁面 -->
        <div class="page list-page active" id="listPage">
            <div class="nav-header">
                <h1 class="app-title">照片列表</h1>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" class="search-input" placeholder="搜尋" id="searchInput" oninput="searchHistory()">
                </div>
            </div>
            
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 4h7V2H4c-1.1 0-2 .9-2 2v7h2V4zm6 9l-4 5h12l-3.5-4.5-2.5 3.01L10 13zM22 11V4c0-1.1-.9-2-2-2h-7v2h7v7h2zm-2 9h-7v2h7c1.1 0 2-.9 2-2v-7h-2v7zM4 13H2v7c0 1.1.9 2 2 2h7v-2H4v-7z"/>
                    </svg>
                </div>
                <h3 class="empty-title">拍攝你的第一張照片</h3>
                <p class="empty-subtitle">開始建立你的價格卡</p>
            </div>
            
            <div class="history-section" id="historySection" style="display: none;">
                <!-- 歷史記錄會動態加入這裡 -->
            </div>
        </div>

        <!-- 底部導航 -->
        <div class="bottom-nav" id="bottomNav">
            <div class="nav-item active" onclick="switchPage('listPage')">
                <svg viewBox="0 0 24 24">
                    <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                </svg>
                <span>照片列表</span>
            </div>
            
            <div class="nav-item nav-camera">
                <div class="camera-btn" onclick="switchPage('cameraPage')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                    </svg>
                </div>
            </div>
            
            <div class="nav-item" onclick="switchPage('settingsPage')">
                <svg viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span>設定</span>
            </div>
        </div>

        <!-- 結果面板 -->
        <div class="result-panel" id="resultPanel">
            <div class="panel-header">
                <div class="panel-handle"></div>
                <button class="panel-close-btn" onclick="closeResult()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="result-content" id="resultContent">
                <!-- 動態內容 -->
            </div>
        </div>

        <!-- 載入動畫 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
            <div class="loading-text">AI 正在分析中...</div>
        </div>
        
        <!-- 聊天頁面 -->
        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <h1 class="chat-title">AI 助手</h1>
                <button class="chat-close-btn" onclick="closeChat()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 對話內容會動態加入這裡 -->
            </div>
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" placeholder="詢問關於這個物品..." rows="1"></textarea>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 隱藏的文件輸入 -->
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
    </div>

    <script>
        // 全域變數
        let stream = null;
        let capturedImage = null;
        let currentAnalysisData = null;
        let flashMode = 'off';
        let currentChatItemId = null;
        
        // DOM 元素
        const pages = {
            settingsPage: document.getElementById('settingsPage'),
            cameraPage: document.getElementById('cameraPage'),
            listPage: document.getElementById('listPage')
        };
        
        const bottomNav = document.getElementById('bottomNav');
        const chatPage = document.getElementById('chatPage');
        
        // 初始化應用
        window.addEventListener('load', () => {
            // 檢查並顯示歷史記錄
            displayHistory();
        });
        
        // 回到首頁（照片列表頁）
        function goToHome() {
            switchPage('listPage');
        }
        
        // 切換頁面
        function switchPage(pageId) {
            // 隱藏所有頁面
            Object.values(pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示目標頁面
            if (pages[pageId]) {
                pages[pageId].classList.add('active');
                
                // 更新底部導航
                updateBottomNav(pageId);
                
                // 如果切換到相機頁面，啟動相機並隱藏底部導航
                if (pageId === 'cameraPage') {
                    initCamera();
                    bottomNav.classList.add('hidden');
                } else {
                    // 關閉相機並顯示底部導航
                    stopCamera();
                    bottomNav.classList.remove('hidden');
                }
                
                // 如果切換到列表頁，更新歷史記錄
                if (pageId === 'listPage') {
                    displayHistory();
                }
            }
        }
        
        // 更新底部導航狀態
        function updateBottomNav(activePageId) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // 根據頁面設定對應的導航項目
            if (activePageId === 'listPage') {
                navItems[0].classList.add('active');
            } else if (activePageId === 'settingsPage') {
                navItems[2].classList.add('active');
            }
        }
        
        // 初始化相機
        async function initCamera() {
            try {
                const cameraFeed = document.getElementById('cameraFeed');
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                // 如果支援，加入閃光燈設定
                if ('torch' in navigator.mediaDevices.getSupportedConstraints()) {
                    constraints.video.torch = flashMode === 'on';
                }
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = stream;
            } catch (error) {
                console.error('無法存取相機:', error);
                alert('請允許相機權限以使用此應用程式');
                switchPage('listPage');
            }
        }
        
        // 停止相機
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        // 切換閃光燈
        async function toggleFlash() {
            if (!stream) return;
            
            try {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (!capabilities.torch) {
                    alert('此裝置不支援閃光燈功能');
                    return;
                }
                
                flashMode = flashMode === 'off' ? 'on' : 'off';
                await track.applyConstraints({
                    advanced: [{ torch: flashMode === 'on' }]
                });
                
                // 更新圖標狀態（可選）
                const flashBtn = document.querySelector('.control-btn:last-child svg');
                flashBtn.style.fill = flashMode === 'on' ? '#FFD700' : '#fff';
            } catch (error) {
                console.error('閃光燈控制失敗:', error);
                alert('無法控制閃光燈');
            }
        }
        
        // 從相簿選擇圖片
        function selectFromGallery() {
            document.getElementById('fileInput').click();
        }
        
        // 處理選擇的檔案
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 檢查檔案類型
            if (!file.type.startsWith('image/')) {
                alert('請選擇圖片檔案');
                return;
            }
            
            // 讀取並顯示圖片
            const reader = new FileReader();
            reader.onload = async function(e) {
                capturedImage = e.target.result;
                
                // 建立圖片元素來調整大小
                const img = new Image();
                img.onload = async function() {
                    const photoCanvas = document.getElementById('photoCanvas');
                    const context = photoCanvas.getContext('2d');
                    
                    // 調整大小
                    const maxWidth = 800;
                    const maxHeight = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    photoCanvas.width = width;
                    photoCanvas.height = height;
                    context.drawImage(img, 0, 0, width, height);
                    
                    // 更新 capturedImage 為調整後的圖片
                    capturedImage = photoCanvas.toDataURL('image/jpeg', 0.7);
                    
                    // 分析圖片
                    analyzeImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // 清除輸入值，允許重複選擇同一檔案
            event.target.value = '';
        }
        
        // 拍照功能
        async function capturePhoto() {
            const cameraFeed = document.getElementById('cameraFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const context = photoCanvas.getContext('2d');
            
            // 設定畫布尺寸
            const maxWidth = 800;
            const maxHeight = 800;
            
            let width = cameraFeed.videoWidth;
            let height = cameraFeed.videoHeight;
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            photoCanvas.width = width;
            photoCanvas.height = height;
            context.drawImage(cameraFeed, 0, 0, width, height);
            
            // 轉換為 base64
            capturedImage = photoCanvas.toDataURL('image/jpeg', 0.7);
            
            // 觸發分析
            analyzeImage();
        }
        
        // 分析圖片
        async function analyzeImage() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const resultPanel = document.getElementById('resultPanel');
            const resultContent = document.getElementById('resultContent');
            
            // 顯示載入動畫
            loadingOverlay.classList.add('active');
            
            try {
                // 將 canvas 轉換為 blob
                const photoCanvas = document.getElementById('photoCanvas');
                const blob = await new Promise(resolve => {
                    photoCanvas.toBlob(resolve, 'image/jpeg', 0.7);
                });
                
                // 準備 FormData
                const formData = new FormData();
                formData.append('image', blob, 'capture.jpg');
                
                // 呼叫後端 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/analyze';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }
                
                const result = await response.json();
                
                // 隱藏載入動畫
                loadingOverlay.classList.remove('active');
                
                if (result.success && result.data) {
                    // 保存當前分析數據
                    currentAnalysisData = result.data;
                    
                    // 顯示結果
                    displayResult(result.data);
                    
                    // 儲存到歷史記錄
                    saveToHistory(result.data);
                    
                    // 切換到列表頁面並顯示結果
                    switchPage('listPage');
                    resultPanel.classList.add('active');
                } else {
                    throw new Error(result.error || '分析失敗');
                }
                
            } catch (error) {
                console.error('分析錯誤:', error);
                loadingOverlay.classList.remove('active');
                alert('分析失敗：' + error.message + '\n請確認網路連線並重試');
            }
        }
        
        // 儲存到歷史記錄
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            
            const historyItem = {
                id: Date.now(),
                name: data.name,
                price: data.price,
                image: capturedImage,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            history.unshift(historyItem);
            
            // 只保留最新 50 筆
            history = history.slice(0, 50);
            
            localStorage.setItem('scanHistory', JSON.stringify(history));
            
            // 設定當前聊天項目 ID
            currentChatItemId = historyItem.id;
        }
        
        // 搜尋歷史記錄
        function searchHistory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            
            // 過濾符合搜尋條件的項目
            const filteredHistory = history.filter(item => {
                return item.name.toLowerCase().includes(searchTerm) ||
                       item.price.toLowerCase().includes(searchTerm);
            });
            
            // 顯示過濾後的結果
            displayHistoryItems(filteredHistory);
        }
        
        // 顯示歷史記錄項目（共用函數）
        function displayHistoryItems(items) {
            const emptyState = document.getElementById('emptyState');
            const historySection = document.getElementById('historySection');
            
            if (items.length === 0) {
                emptyState.style.display = 'flex';
                historySection.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                historySection.style.display = 'block';
                
                // 按月份分組
                const groupedByMonth = {};
                items.forEach(item => {
                    const date = new Date(item.timestamp);
                    const monthKey = `${date.getFullYear()}年${date.getMonth() + 1}月`;
                    
                    if (!groupedByMonth[monthKey]) {
                        groupedByMonth[monthKey] = [];
                    }
                    groupedByMonth[monthKey].push(item);
                });
                
                // 生成HTML
                let html = '';
                Object.keys(groupedByMonth).forEach(month => {
                    html += `<div class="month-label">${month}</div>`;
                    html += '<div class="history-grid">';
                    
                    groupedByMonth[month].forEach(item => {
                        html += `
                            <div class="history-item" onclick="showHistoryItem(${item.id})">
                                <img src="${item.image}" alt="${item.name}" class="history-img">
                                <div class="history-info">
                                    <div class="history-name">${item.name}</div>
                                    <div class="history-price">${item.price}</div>
                                    <div class="history-date">${formatDateDisplay(item.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                historySection.innerHTML = html;
            }
        }
        
        // 顯示歷史記錄
        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            displayHistoryItems(history);
        }
        
        // 顯示歷史記錄項目
        function showHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const item = history.find(h => h.id === id);
            
            if (item) {
                capturedImage = item.image;
                currentAnalysisData = item.data;
                currentChatItemId = item.id;  // 設定當前聊天項目 ID
                displayResult(item.data);
                
                const resultPanel = document.getElementById('resultPanel');
                resultPanel.classList.add('active');
            }
        }
        
        // 格式化日期顯示
        function formatDateDisplay(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            return `${year}/${month}/${day}`;
        }
        
        // 格式化日期（保留原函數用於其他地方）
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '剛剛';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} 分鐘前`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} 小時前`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} 天前`;
            
            return date.toLocaleDateString('zh-TW');
        }
        
        // 顯示結果
        function displayResult(data) {
            const resultContent = document.getElementById('resultContent');
            
            // 生成購買連結
            let purchaseLinks = '';
            if (data.purchaseLinks && data.purchaseLinks.online && data.purchaseLinks.online.length > 0) {
                purchaseLinks = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">購買管道</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${data.purchaseLinks.online.map(link => `
                                <a href="${getPlatformUrl(link.platform, link.searchTerm)}" 
                                   target="_blank" 
                                   style="display: inline-flex; align-items: center; padding: 8px 16px; background: #FF6B35; color: white; border-radius: 20px; text-decoration: none; font-size: 14px;">
                                    ${link.platform}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            resultContent.innerHTML = `
                <img src="${capturedImage}" alt="拍攝的物品" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 20px;">
                
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">${data.name}</h2>
                
                <div class="price-section">
                    <div style="font-size: 16px; opacity: 0.9;">預估價格</div>
                    <div class="price-value">${data.price}</div>
                    <div style="font-size: 14px; opacity: 0.8;">${data.priceNote}</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="openChat()" style="flex: 1; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        詢問 AI
                    </button>
                    <button onclick="shareResult()" style="flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        分享
                    </button>
                </div>
                
                ${purchaseLinks}
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">基本資訊</h3>
                    <p style="color: #666; line-height: 1.6;">${data.description}</p>
                </div>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">在哪裡買</h3>
                    <p style="color: #666; line-height: 1.6;">${data.availability}</p>
                </div>
                
                <button onclick="closeResult()" style="width: 100%; padding: 15px; background: #FF6B35; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    關閉
                </button>
                
                <p class="disclaimer-text">所有資訊皆由 GPT 產出</p>
            `;
        }
        
        // 取得平台 URL
        function getPlatformUrl(platform, searchTerm) {
            const urls = {
                '蝦皮購物': `https://shopee.tw/search?keyword=${encodeURIComponent(searchTerm)}`,
                'PChome 24h': `https://24h.pchome.com.tw/search/?q=${encodeURIComponent(searchTerm)}`,
                'momo購物網': `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${encodeURIComponent(searchTerm)}`,
                '露天拍賣': `https://find.ruten.com.tw/s/?q=${encodeURIComponent(searchTerm)}`,
                'Yahoo拍賣': `https://tw.search.yahoo.com/search?p=${encodeURIComponent(searchTerm)}`
            };
            return urls[platform] || '#';
        }
        
        // 打開聊天頁面
        function openChat() {
            // 設定當前聊天項目 ID
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const currentItem = history.find(item => 
                item.image === capturedImage && 
                item.data.name === currentAnalysisData.name
            );
            
            if (currentItem) {
                currentChatItemId = currentItem.id;
                loadChatHistory();
                chatPage.classList.add('active');
                
                // 如果沒有歷史對話，顯示歡迎訊息
                const chatHistory = getChatHistory();
                if (chatHistory.length === 0) {
                    addMessage('assistant', `你好！我是 AI 助手，我可以回答關於「${currentAnalysisData.name}」的任何問題。請問有什麼想了解的嗎？`);
                }
            }
        }
        
        // 關閉聊天頁面
        function closeChat() {
            chatPage.classList.remove('active');
            currentChatItemId = null;
        }
        
        // 獲取聊天歷史
        function getChatHistory() {
            if (!currentChatItemId) return [];
            const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            return allChats[currentChatItemId] || [];
        }
        
        // 保存聊天歷史
        function saveChatHistory(messages) {
            if (!currentChatItemId) return;
            const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            allChats[currentChatItemId] = messages;
            localStorage.setItem('chatHistory', JSON.stringify(allChats));
        }
        
        // 載入聊天歷史
        function loadChatHistory() {
            const messages = getChatHistory();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                addMessageToUI(msg.role, msg.content);
            });
            
            // 滾動到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加訊息到 UI
        function addMessageToUI(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatarText = role === 'user' ? '你' : 'AI';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarText}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加訊息並保存
        function addMessage(role, content) {
            const messages = getChatHistory();
            messages.push({ role, content, timestamp: new Date().toISOString() });
            saveChatHistory(messages);
            addMessageToUI(role, content);
        }
        
        // 發送訊息
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // 添加用戶訊息
            addMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // 禁用發送按鈕
            chatSendBtn.disabled = true;
            
            // 顯示載入動畫
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="chat-loading">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // 準備請求數據
                const formData = new FormData();
                
                // 將 base64 圖片轉換為 Blob
                const base64Data = capturedImage.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                
                formData.append('image', blob, 'item.jpg');
                formData.append('message', message);
                formData.append('itemInfo', JSON.stringify(currentAnalysisData));
                formData.append('chatHistory', JSON.stringify(getChatHistory()));
                
                // 呼叫 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/chat';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }
                
                const result = await response.json();
                
                // 移除載入動畫
                loadingDiv.remove();
                
                if (result.success) {
                    // 添加 AI 回覆
                    addMessage('assistant', result.data.reply);
                } else {
                    throw new Error(result.error || '回覆失敗');
                }
                
            } catch (error) {
                console.error('聊天錯誤:', error);
                loadingDiv.remove();
                addMessage('assistant', '抱歉，我現在無法回答您的問題。請稍後再試。');
            } finally {
                // 重新啟用發送按鈕
                chatSendBtn.disabled = false;
            }
        }
        
        // 監聽輸入框 Enter 鍵
        document.getElementById('chatInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // 自動調整輸入框高度
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // 分享結果
        async function shareResult() {
            if (!currentAnalysisData) {
                alert('沒有可分享的資料');
                return;
            }
            
            try {
                // 準備分享數據
                const shareData = {
                    name: currentAnalysisData.name,
                    price: currentAnalysisData.price,
                    priceNote: currentAnalysisData.priceNote,
                    description: currentAnalysisData.description,
                    availability: currentAnalysisData.availability,
                    purchaseLinks: currentAnalysisData.purchaseLinks,
                    image: capturedImage
                };
                
                // 呼叫後端 API 生成分享連結
                const API_URL = 'https://price-scanner-backend.vercel.app/api/share';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shareData)
                });
                
                if (!response.ok) {
                    throw new Error('分享失敗');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const shareUrl = `https://lynn800741.github.io/price-scanner-app/share.html?id=${result.shareId}`;
                    const shareText = `我用萬物價格掃描器發現了「${currentAnalysisData.name}」\n價格：${currentAnalysisData.price}\n${currentAnalysisData.description}\n\n查看詳情：${shareUrl}`;
                    
                    if (navigator.share) {
                        navigator.share({
                            title: '萬物價格掃描器',
                            text: shareText,
                            url: shareUrl
                        }).catch(err => console.log('分享取消'));
                    } else {
                        // 複製到剪貼板
                        navigator.clipboard.writeText(shareText).then(() => {
                            alert('分享連結已複製到剪貼板！');
                        });
                    }
                } else {
                    throw new Error(result.error || '分享失敗');
                }
                
            } catch (error) {
                console.error('分享錯誤:', error);
                // 如果 API 還未實現，使用本地分享
                const shareText = `我用萬物價格掃描器發現了「${currentAnalysisData.name}」\n價格：${currentAnalysisData.price}\n${currentAnalysisData.description}\n\n立即試用：https://lynn800741.github.io/price-scanner-app/`;
                
                if (navigator.share) {
                    navigator.share({
                        title: '萬物價格掃描器',
                        text: shareText
                    }).catch(err => console.log('分享取消'));
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('分享文字已複製到剪貼板！\n\n注意：分享連結功能需要後端支援。');
                    });
                }
            }
        }
        
        // 關閉結果面板
        function closeResult() {
            const resultPanel = document.getElementById('resultPanel');
            resultPanel.classList.remove('active');
        }
        
        // 清理資源
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>
